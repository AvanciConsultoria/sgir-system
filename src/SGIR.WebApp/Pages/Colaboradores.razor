@page "/colaboradores"
@using Microsoft.EntityFrameworkCore
@using SGIR.Core.Entities
@using SGIR.Infrastructure.Data
@inject SGIRDbContext DbContext

<PageTitle>Colaboradores - SGIR</PageTitle>

<div class="container-fluid">
    <div class="row mb-3">
        <div class="col-md-6">
            <h2>üë• Gerenciamento de Colaboradores</h2>
        </div>
        <div class="col-md-6 text-end">
            <button class="btn btn-primary" @onclick="MostrarFormularioNovo">
                ‚ûï Novo Colaborador
            </button>
        </div>
    </div>

    <!-- Formul√°rio de Cadastro/Edi√ß√£o -->
    @if (mostrarFormulario)
    {
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">@(colaboradorEditando?.Id > 0 ? "‚úèÔ∏è Editar Colaborador" : "‚ûï Novo Colaborador")</h5>
            </div>
            <div class="card-body">
                <form>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">CPF *</label>
                            <input type="text" class="form-control" @bind="colaboradorEditando.CPF" required maxlength="14" placeholder="000.000.000-00" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nome Completo *</label>
                            <input type="text" class="form-control" @bind="colaboradorEditando.Nome" required />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Fun√ß√£o *</label>
                            <input type="text" class="form-control" @bind="colaboradorEditando.Funcao" required placeholder="Ex: Eletricista, Mec√¢nico, T√©cnico..." />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Data de Admiss√£o</label>
                            <input type="date" class="form-control" @bind="colaboradorEditando.DataAdmissao" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Telefone</label>
                            <input type="text" class="form-control" @bind="colaboradorEditando.Telefone" placeholder="(00) 00000-0000" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" @bind="colaboradorEditando.Email" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <button type="button" class="btn btn-success me-2" @onclick="SalvarColaborador">
                                üíæ Salvar
                            </button>
                            <button type="button" class="btn btn-secondary" @onclick="CancelarEdicao">
                                ‚ùå Cancelar
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    }

    <!-- Filtro de Busca -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-10">
                    <input type="text" class="form-control" placeholder="üîç Buscar por CPF, nome ou fun√ß√£o..." @bind="filtro" @bind:event="oninput" @onkeyup="FiltrarColaboradores" />
                </div>
                <div class="col-md-2">
                    <button class="btn btn-secondary w-100" @onclick="LimparFiltro">
                        üîÑ Limpar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabela de Colaboradores -->
    <div class="card">
        <div class="card-header bg-dark text-white">
            <h5 class="mb-0">üìä Lista de Colaboradores (@colaboradoresFiltrados.Count)</h5>
        </div>
        <div class="card-body">
            @if (isLoading)
            {
                <div class="text-center p-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <p class="mt-2">Carregando colaboradores...</p>
                </div>
            }
            else if (!colaboradoresFiltrados.Any())
            {
                <div class="alert alert-info mb-0">
                    <strong>‚ÑπÔ∏è Nenhum colaborador encontrado.</strong>
                    <p class="mb-0 mt-2">Clique em "Novo Colaborador" para cadastrar o primeiro colaborador.</p>
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-hover table-striped">
                        <thead>
                            <tr>
                                <th>CPF</th>
                                <th>Nome</th>
                                <th>Fun√ß√£o</th>
                                <th>Admiss√£o</th>
                                <th>Status</th>
                                <th>Certifica√ß√µes</th>
                                <th style="width: 180px;">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var colab in colaboradoresFiltrados)
                            {
                                var certificacoesValidas = colab.Certificacoes?.Count(c => c.DataValidade >= DateTime.Today) ?? 0;
                                var totalCertificacoes = colab.Certificacoes?.Count ?? 0;
                                var isApto = certificacoesValidas > 0 && certificacoesValidas == totalCertificacoes;
                                
                                <tr>
                                    <td><code>@colab.CPF</code></td>
                                    <td><strong>@colab.Nome</strong></td>
                                    <td>@colab.Funcao</td>
                                    <td>@(colab.DataAdmissao?.ToString("dd/MM/yyyy") ?? "-")</td>
                                    <td>
                                        @if (isApto && totalCertificacoes > 0)
                                        {
                                            <span class="badge bg-success">üü¢ APTO</span>
                                        }
                                        else if (totalCertificacoes == 0)
                                        {
                                            <span class="badge bg-secondary">‚ö™ SEM CERT.</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-danger">üî¥ INAPTO</span>
                                        }
                                    </td>
                                    <td>
                                        <span class="badge bg-info">@certificacoesValidas / @totalCertificacoes v√°lidas</span>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-info me-1" title="Certifica√ß√µes" @onclick="@(() => GerenciarCertificacoes(colab))">
                                            üìú
                                        </button>
                                        <button class="btn btn-sm btn-warning me-1" title="Editar" @onclick="@(() => EditarColaborador(colab))">
                                            ‚úèÔ∏è
                                        </button>
                                        <button class="btn btn-sm btn-danger" title="Excluir" @onclick="@(() => ExcluirColaborador(colab))">
                                            üóëÔ∏è
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private List<Colaborador> colaboradores = new();
    private List<Colaborador> colaboradoresFiltrados = new();
    private bool mostrarFormulario = false;
    private bool isLoading = true;
    private string filtro = string.Empty;
    private Colaborador colaboradorEditando = new();

    protected override async Task OnInitializedAsync()
    {
        await CarregarColaboradores();
    }

    private async Task CarregarColaboradores()
    {
        try
        {
            isLoading = true;
            colaboradores = await DbContext.Colaboradores
                .Include(c => c.Certificacoes)
                .OrderBy(c => c.Nome)
                .ToListAsync();
            colaboradoresFiltrados = colaboradores;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erro ao carregar colaboradores: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void MostrarFormularioNovo()
    {
        colaboradorEditando = new Colaborador();
        mostrarFormulario = true;
    }

    private void EditarColaborador(Colaborador colab)
    {
        colaboradorEditando = new Colaborador
        {
            Id = colab.Id,
            CPF = colab.CPF,
            Nome = colab.Nome,
            Funcao = colab.Funcao,
            DataAdmissao = colab.DataAdmissao,
            Telefone = colab.Telefone,
            Email = colab.Email
        };
        mostrarFormulario = true;
    }

    private async Task SalvarColaborador()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(colaboradorEditando.CPF) || 
                string.IsNullOrWhiteSpace(colaboradorEditando.Nome) ||
                string.IsNullOrWhiteSpace(colaboradorEditando.Funcao))
            {
                Console.WriteLine("Campos obrigat√≥rios n√£o preenchidos");
                return;
            }

            if (colaboradorEditando.Id > 0)
            {
                // Editar
                var colabDb = await DbContext.Colaboradores.FindAsync(colaboradorEditando.Id);
                if (colabDb != null)
                {
                    colabDb.CPF = colaboradorEditando.CPF;
                    colabDb.Nome = colaboradorEditando.Nome;
                    colabDb.Funcao = colaboradorEditando.Funcao;
                    colabDb.DataAdmissao = colaboradorEditando.DataAdmissao;
                    colabDb.Telefone = colaboradorEditando.Telefone;
                    colabDb.Email = colaboradorEditando.Email;
                    colabDb.DataAtualizacao = DateTime.Now;
                }
            }
            else
            {
                // Novo
                DbContext.Colaboradores.Add(colaboradorEditando);
            }

            await DbContext.SaveChangesAsync();
            await CarregarColaboradores();
            CancelarEdicao();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erro ao salvar colaborador: {ex.Message}");
        }
    }

    private async Task ExcluirColaborador(Colaborador colab)
    {
        try
        {
            DbContext.Colaboradores.Remove(colab);
            await DbContext.SaveChangesAsync();
            await CarregarColaboradores();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erro ao excluir colaborador: {ex.Message}");
        }
    }

    private void CancelarEdicao()
    {
        colaboradorEditando = new Colaborador();
        mostrarFormulario = false;
    }

    private void FiltrarColaboradores()
    {
        if (string.IsNullOrWhiteSpace(filtro))
        {
            colaboradoresFiltrados = colaboradores;
        }
        else
        {
            var filtroLower = filtro.ToLower();
            colaboradoresFiltrados = colaboradores.Where(c => 
                c.CPF.ToLower().Contains(filtroLower) ||
                c.Nome.ToLower().Contains(filtroLower) ||
                c.Funcao.ToLower().Contains(filtroLower)
            ).ToList();
        }
    }

    private void LimparFiltro()
    {
        filtro = string.Empty;
        FiltrarColaboradores();
    }

    private void GerenciarCertificacoes(Colaborador colab)
    {
        // TODO: Implementar p√°gina de gerenciamento de certifica√ß√µes
        Console.WriteLine($"Gerenciar certifica√ß√µes para: {colab.Nome}");
    }
}
