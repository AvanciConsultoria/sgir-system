@page "/"
@page "/dashboard"
@using Microsoft.EntityFrameworkCore
@using SGIR.Core.Entities
@using SGIR.Infrastructure.Data
@inject SGIRDbContext DbContext
@inject NavigationManager Navigation

<PageTitle>Dashboard - SGIR</PageTitle>

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h2>üìä Painel de Controle - SGIR</h2>
            <p class="text-muted">Sistema de Gest√£o Integrada de Recursos</p>
        </div>
    </div>

    <!-- Cards de Estat√≠sticas -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-white bg-primary mb-3" style="cursor: pointer;" @onclick="@(() => Navigation.NavigateTo("/projetos"))">
                <div class="card-body">
                    <h5 class="card-title">üìã Projetos</h5>
                    <h2 class="mb-0">@TotalProjetos</h2>
                    <small>Projetos cadastrados</small>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card text-white bg-success mb-3" style="cursor: pointer;" @onclick="@(() => Navigation.NavigateTo("/colaboradores"))">
                <div class="card-body">
                    <h5 class="card-title">üë• Colaboradores</h5>
                    <h2 class="mb-0">@ColaboradoresAptos / @TotalColaboradores</h2>
                    <small>Aptos / Total</small>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card text-white bg-warning mb-3" style="cursor: pointer;" @onclick="@(() => Navigation.NavigateTo("/ferramentas"))">
                <div class="card-body">
                    <h5 class="card-title">üì¶ Estoque</h5>
                    <h2 class="mb-0">@TotalFerramentas</h2>
                    <small>Itens cadastrados</small>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card text-white bg-danger mb-3" style="cursor: pointer;" @onclick="@(() => Navigation.NavigateTo("/compras"))">
                <div class="card-body">
                    <h5 class="card-title">üõí Compras</h5>
                    <h2 class="mb-0">@ComprasPendentes</h2>
                    <small>Pedidos pendentes</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Informa√ß√µes de Status -->
    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header bg-warning text-white">
                    <h5 class="mb-0">‚ö†Ô∏è Certifica√ß√µes Vencendo (30 dias)</h5>
                </div>
                <div class="card-body">
                    @if (CertificacoesVencendo.Any())
                    {
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    <th>Colaborador</th>
                                    <th>Certifica√ß√£o</th>
                                    <th>Validade</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var cert in CertificacoesVencendo)
                                {
                                    <tr>
                                        <td>@cert.Colaborador?.Nome</td>
                                        <td><span class="badge bg-warning text-dark">@cert.TipoCertificacao</span></td>
                                        <td>@cert.DataValidade.ToString("dd/MM/yyyy")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                    else
                    {
                        <div class="alert alert-success mb-0">
                            ‚úÖ Nenhuma certifica√ß√£o vencendo nos pr√≥ximos 30 dias
                        </div>
                    }
                </div>
            </div>
        </div>
        
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">üìä Estat√≠sticas R√°pidas</h5>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            üîß Caixas de Ferramentas
                            <span class="badge bg-primary rounded-pill">@TotalCaixas</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            üõí Carrinhos
                            <span class="badge bg-primary rounded-pill">@TotalCarrinhos</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            üí∞ Custos Operacionais
                            <span class="badge bg-success rounded-pill">@TotalCustos</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            üìà An√°lises de D√©ficit
                            <span class="badge bg-info rounded-pill">@TotalAnalises</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- A√ß√µes R√°pidas -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">‚ö° A√ß√µes R√°pidas</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-2">
                            <button class="btn btn-primary w-100" @onclick="@(() => Navigation.NavigateTo("/projetos"))">
                                ‚ûï Novo Projeto
                            </button>
                        </div>
                        <div class="col-md-3 mb-2">
                            <button class="btn btn-success w-100" @onclick="@(() => Navigation.NavigateTo("/colaboradores"))">
                                ‚ûï Novo Colaborador
                            </button>
                        </div>
                        <div class="col-md-3 mb-2">
                            <button class="btn btn-warning w-100" @onclick="@(() => Navigation.NavigateTo("/ferramentas"))">
                                ‚ûï Nova Ferramenta
                            </button>
                        </div>
                        <div class="col-md-3 mb-2">
                            <button class="btn btn-info w-100" @onclick="@(() => Navigation.NavigateTo("/analises"))">
                                üìä An√°lise de D√©ficit
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @if (IsLoading)
    {
        <div class="row mt-4">
            <div class="col-12 text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Carregando...</span>
                </div>
                <p class="mt-2">Carregando dados...</p>
            </div>
        </div>
    }
</div>

@code {
    private bool IsLoading = true;
    
    private int TotalProjetos = 0;
    private int TotalColaboradores = 0;
    private int ColaboradoresAptos = 0;
    private int TotalFerramentas = 0;
    private int ComprasPendentes = 0;
    private int TotalCaixas = 0;
    private int TotalCarrinhos = 0;
    private int TotalCustos = 0;
    private int TotalAnalises = 0;
    
    private List<Certificacao> CertificacoesVencendo = new();
    
    protected override async Task OnInitializedAsync()
    {
        try
        {
            IsLoading = true;
            await CarregarEstatisticas();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erro ao carregar dashboard: {ex.Message}");
        }
        finally
        {
            IsLoading = false;
        }
    }
    
    private async Task CarregarEstatisticas()
    {
        try
        {
            // Projetos
            TotalProjetos = await DbContext.Projetos.CountAsync();
            
            // Colaboradores
            TotalColaboradores = await DbContext.Colaboradores.CountAsync();
            var hoje = DateTime.Today;
            var colaboradoresComCertificacoesValidas = await DbContext.Colaboradores
                .Include(c => c.Certificacoes)
                .Where(c => c.Certificacoes.Any(cert => cert.DataValidade >= hoje))
                .CountAsync();
            ColaboradoresAptos = colaboradoresComCertificacoesValidas;
            
            // Ferramentas
            TotalFerramentas = await DbContext.ItensEstoque.CountAsync();
            
            // Compras
            ComprasPendentes = await DbContext.ComprasAutomaticas
                .Where(c => c.Status == SGIR.Core.Enums.StatusCompra.Pendente)
                .CountAsync();
            
            // Caixas, Carrinhos, Custos, An√°lises
            TotalCaixas = await DbContext.CaixasFerramentas.CountAsync();
            TotalCarrinhos = await DbContext.Carrinhos.CountAsync();
            TotalCustos = await DbContext.CustosOperacionais.CountAsync();
            TotalAnalises = await DbContext.AnalisesDeficit.CountAsync();
            
            // Certifica√ß√µes vencendo nos pr√≥ximos 30 dias
            var dataLimite = hoje.AddDays(30);
            CertificacoesVencendo = await DbContext.Certificacoes
                .Include(c => c.Colaborador)
                .Where(c => c.DataValidade >= hoje && c.DataValidade <= dataLimite)
                .OrderBy(c => c.DataValidade)
                .Take(10)
                .ToListAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erro ao carregar estat√≠sticas: {ex.Message}");
        }
    }
}
