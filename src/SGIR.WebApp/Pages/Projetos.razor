@page "/projetos"
@using SGIR.Core.Entities
@using SGIR.Core.Interfaces
@inject IUnitOfWork UnitOfWork

<PageTitle>Projetos - SGIR</PageTitle>

<div class="card mb-4">
    <div class="card-header">
        <h3>üìã Projetos (OS)</h3>
        <button class="btn btn-primary" @onclick="AbrirModal">
            ‚ûï Novo Projeto
        </button>
    </div>
    <div class="card-body">
        @if (isLoading)
        {
            <div class="text-center">
                <p>Carregando projetos...</p>
            </div>
        }
        else if (!projetos.Any())
        {
            <div class="alert alert-info">
                <strong>‚ÑπÔ∏è Nenhum projeto cadastrado</strong>
                <p style="margin: 0.5rem 0 0 0;">
                    Clique em "Novo Projeto" para adicionar uma ordem de servi√ßo.
                </p>
            </div>
        }
        else
        {
            <!-- Estat√≠sticas -->
            <div class="stats-grid mb-4">
                <div class="stat-card blue">
                    <div class="stat-icon">üìã</div>
                    <div class="stat-info">
                        <div class="stat-label">Total de Projetos</div>
                        <div class="stat-value">@projetos.Count()</div>
                    </div>
                </div>
                <div class="stat-card success">
                    <div class="stat-icon">‚è≥</div>
                    <div class="stat-info">
                        <div class="stat-label">Em Andamento</div>
                        <div class="stat-value">@projetos.Count(p => p.Status == "Em andamento")</div>
                    </div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-icon">üìÖ</div>
                    <div class="stat-info">
                        <div class="stat-label">Planejamento</div>
                        <div class="stat-value">@projetos.Count(p => p.Status == "Planejamento")</div>
                    </div>
                </div>
                <div class="stat-card danger">
                    <div class="stat-icon">‚úÖ</div>
                    <div class="stat-info">
                        <div class="stat-label">Conclu√≠dos</div>
                        <div class="stat-value">@projetos.Count(p => p.Status == "Conclu√≠do")</div>
                    </div>
                </div>
            </div>

            <!-- Tabela de Projetos -->
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>OS ID</th>
                            <th>Nome da Atividade</th>
                            <th>Local</th>
                            <th>Status</th>
                            <th>Data In√≠cio</th>
                            <th>Prazo (dias)</th>
                            <th>Fim Previsto</th>
                            <th>Colaboradores</th>
                            <th style="text-align: center;">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var projeto in projetos)
                        {
                            <tr>
                                <td>
                                    <strong style="color: var(--primary-blue);">OS-@projeto.Id</strong>
                                </td>
                                <td>
                                    <strong>@projeto.NomeAtividade</strong>
                                </td>
                                <td>@projeto.Local</td>
                                <td>
                                    @if (projeto.Status == "Em andamento")
                                    {
                                        <span class="badge badge-success">‚è≥ @projeto.Status</span>
                                    }
                                    else if (projeto.Status == "Planejamento")
                                    {
                                        <span class="badge badge-warning">üìÖ @projeto.Status</span>
                                    }
                                    else if (projeto.Status == "Conclu√≠do")
                                    {
                                        <span class="badge badge-info">‚úÖ @projeto.Status</span>
                                    }
                                    else
                                    {
                                        <span class="badge badge-primary">@projeto.Status</span>
                                    }
                                </td>
                                <td>@projeto.DataInicio.ToString("dd/MM/yyyy")</td>
                                <td style="text-align: center;">@projeto.PrazoDias</td>
                                <td>
                                    @if (projeto.DataFimPrevista.HasValue)
                                    {
                                        <span>@projeto.DataFimPrevista.Value.ToString("dd/MM/yyyy")</span>
                                        @if (projeto.DataFimPrevista.Value < DateTime.Today && projeto.Status != "Conclu√≠do")
                                        {
                                            <span class="badge badge-danger" style="margin-left: 0.5rem;">‚ö†Ô∏è Atrasado</span>
                                        }
                                    }
                                    else
                                    {
                                        <span class="text-muted">-</span>
                                    }
                                </td>
                                <td>
                                    @{
                                        var alocacoes = projeto.Alocacoes?.Count() ?? 0;
                                    }
                                    @if (alocacoes > 0)
                                    {
                                        <span class="badge badge-primary">üë• @alocacoes pessoa(s)</span>
                                    }
                                    else
                                    {
                                        <span class="text-muted">Nenhum</span>
                                    }
                                </td>
                                <td style="text-align: center;">
                                    <div class="flex gap-1" style="justify-content: center;">
                                        <button class="btn btn-sm btn-outline" @onclick="() => EditarProjeto(projeto)">
                                            ‚úèÔ∏è
                                        </button>
                                        <a href="/gap-analysis?projetoId=@projeto.Id" class="btn btn-sm btn-warning">
                                            üìä
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>
</div>

<!-- Modal -->
@if (mostrarModal)
{
    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999;" @onclick="FecharModal">
        <div class="card" style="width: 800px; max-width: 90%; max-height: 90vh; overflow-y: auto;" @onclick:stopPropagation="true">
            <div class="card-header">
                <h4>@(projetoEditando == null ? "Novo Projeto" : $"Editar Projeto OS-{projetoEditando.Id}")</h4>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label class="form-label">Nome da Atividade *</label>
                    <input type="text" 
                           class="form-control" 
                           @bind="nomeAtividade" 
                           placeholder="Ex: Retrofit de prensa hidr√°ulica" />
                </div>

                <div class="grid grid-cols-2 gap-2">
                    <div class="form-group">
                        <label class="form-label">Local *</label>
                        <input type="text" 
                               class="form-control" 
                               @bind="local" 
                               placeholder="Ex: Planta Curitiba" />
                    </div>

                    <div class="form-group">
                        <label class="form-label">Prazo (dias) *</label>
                        <input type="number" 
                               class="form-control" 
                               @bind="prazoDias" 
                               min="1" 
                               placeholder="30" />
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-2">
                    <div class="form-group">
                        <label class="form-label">Data de In√≠cio *</label>
                        <input type="date" 
                               class="form-control" 
                               @bind="dataInicio" />
                    </div>

                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-control form-select" @bind="status">
                            <option value="Planejamento">üìÖ Planejamento</option>
                            <option value="Em andamento">‚è≥ Em andamento</option>
                            <option value="Pausado">‚è∏Ô∏è Pausado</option>
                            <option value="Conclu√≠do">‚úÖ Conclu√≠do</option>
                            <option value="Cancelado">‚ùå Cancelado</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Alocar Colaboradores</label>
                    <select class="form-control form-select" multiple size="5" @bind="colaboradoresSelecionados">
                        @foreach (var colaborador in colaboradores)
                        {
                            <option value="@colaborador.Cpf">
                                @colaborador.Nome - @colaborador.Funcao (@colaborador.StatusGeral)
                            </option>
                        }
                    </select>
                    <small class="text-muted">Segure Ctrl/Cmd para selecionar m√∫ltiplos colaboradores</small>
                </div>

                <div class="form-group">
                    <label class="form-label">Recursos Necess√°rios</label>
                    <select class="form-control form-select" multiple size="5" @bind="recursosSelecionados">
                        @foreach (var item in itensEstoque)
                        {
                            <option value="@item.Id">
                                @item.Descricao (@item.EstoqueAtual @item.Unidade dispon√≠vel)
                            </option>
                        }
                    </select>
                    <small class="text-muted">Segure Ctrl/Cmd para selecionar m√∫ltiplos recursos</small>
                </div>
            </div>
            <div class="card-footer">
                <div class="flex justify-between">
                    <button class="btn btn-secondary" @onclick="FecharModal">Cancelar</button>
                    <button class="btn btn-primary" @onclick="SalvarProjeto">
                        üíæ Salvar Projeto
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private bool isLoading = true;
    private bool mostrarModal = false;
    private List<Projeto> projetos = new();
    private List<Colaborador> colaboradores = new();
    private List<ItemEstoque> itensEstoque = new();
    private Projeto? projetoEditando = null;

    // Campos do formul√°rio
    private string nomeAtividade = "";
    private string local = "";
    private int prazoDias = 30;
    private DateTime dataInicio = DateTime.Today;
    private string status = "Planejamento";
    private List<string> colaboradoresSelecionados = new();
    private List<int> recursosSelecionados = new();

    protected override async Task OnInitializedAsync()
    {
        await CarregarDados();
    }

    private async Task CarregarDados()
    {
        try
        {
            isLoading = true;
            
            projetos = (await UnitOfWork.Projetos.GetAllAsync()).OrderByDescending(p => p.Id).ToList();
            colaboradores = (await UnitOfWork.Colaboradores.GetAllAsync()).OrderBy(c => c.Nome).ToList();
            itensEstoque = (await UnitOfWork.ItensEstoque.GetAllAsync()).OrderBy(i => i.Descricao).ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erro ao carregar projetos: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void AbrirModal()
    {
        projetoEditando = null;
        LimparFormulario();
        mostrarModal = true;
    }

    private void EditarProjeto(Projeto projeto)
    {
        projetoEditando = projeto;
        nomeAtividade = projeto.NomeAtividade;
        local = projeto.Local;
        prazoDias = projeto.PrazoDias;
        dataInicio = projeto.DataInicio;
        status = projeto.Status ?? "Planejamento";
        mostrarModal = true;
    }

    private async Task SalvarProjeto()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(nomeAtividade) || string.IsNullOrWhiteSpace(local))
            {
                Console.WriteLine("Preencha todos os campos obrigat√≥rios");
                return;
            }

            // TODO: Implementar salvamento real
            Console.WriteLine($"Salvar projeto: {nomeAtividade}");
            
            FecharModal();
            await CarregarDados();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erro ao salvar projeto: {ex.Message}");
        }
    }

    private void FecharModal()
    {
        mostrarModal = false;
        projetoEditando = null;
        LimparFormulario();
    }

    private void LimparFormulario()
    {
        nomeAtividade = "";
        local = "";
        prazoDias = 30;
        dataInicio = DateTime.Today;
        status = "Planejamento";
        colaboradoresSelecionados.Clear();
        recursosSelecionados.Clear();
    }
}
