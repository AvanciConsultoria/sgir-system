@page "/projetos"
@using Microsoft.EntityFrameworkCore
@using SGIR.Core.Entities
@using SGIR.Infrastructure.Data
@inject SGIRDbContext DbContext

<PageTitle>Projetos - SGIR</PageTitle>

<div class="container-fluid">
    <div class="row mb-3">
        <div class="col-md-6">
            <h2>üìã Gerenciamento de Projetos</h2>
        </div>
        <div class="col-md-6 text-end">
            <button class="btn btn-primary" @onclick="MostrarFormularioNovo">
                ‚ûï Novo Projeto
            </button>
        </div>
    </div>

    <!-- Formul√°rio de Cadastro/Edi√ß√£o -->
    @if (mostrarFormulario)
    {
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">@(projetoEditando?.Id > 0 ? "‚úèÔ∏è Editar Projeto" : "‚ûï Novo Projeto")</h5>
            </div>
            <div class="card-body">
                <form>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">OS *</label>
                            <input type="text" class="form-control" @bind="projetoEditando.OsId" required />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nome do Projeto *</label>
                            <input type="text" class="form-control" @bind="projetoEditando.NomeProjeto" required />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Cliente *</label>
                            <input type="text" class="form-control" @bind="projetoEditando.Cliente" required />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Local *</label>
                            <input type="text" class="form-control" @bind="projetoEditando.Local" required />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Gestor do Projeto</label>
                            <input type="text" class="form-control" @bind="projetoEditando.GestorProjeto" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Data de In√≠cio</label>
                            <input type="date" class="form-control" @bind="projetoEditando.DataInicio" />
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12 mb-3">
                            <label class="form-label">Descri√ß√£o</label>
                            <textarea class="form-control" rows="3" @bind="projetoEditando.Descricao"></textarea>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <button type="button" class="btn btn-success me-2" @onclick="SalvarProjeto">
                                üíæ Salvar
                            </button>
                            <button type="button" class="btn btn-secondary" @onclick="CancelarEdicao">
                                ‚ùå Cancelar
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    }

    <!-- Filtro de Busca -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-10">
                    <input type="text" class="form-control" placeholder="üîç Buscar por OS, nome, cliente ou local..." @bind="filtro" @bind:event="oninput" @onkeyup="FiltrarProjetos" />
                </div>
                <div class="col-md-2">
                    <button class="btn btn-secondary w-100" @onclick="LimparFiltro">
                        üîÑ Limpar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabela de Projetos -->
    <div class="card">
        <div class="card-header bg-dark text-white">
            <h5 class="mb-0">üìä Lista de Projetos (@projetosFiltrados.Count)</h5>
        </div>
        <div class="card-body">
            @if (isLoading)
            {
                <div class="text-center p-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <p class="mt-2">Carregando projetos...</p>
                </div>
            }
            else if (!projetosFiltrados.Any())
            {
                <div class="alert alert-info mb-0">
                    <strong>‚ÑπÔ∏è Nenhum projeto encontrado.</strong>
                    <p class="mb-0 mt-2">Clique em "Novo Projeto" para cadastrar o primeiro projeto.</p>
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-hover table-striped">
                        <thead>
                            <tr>
                                <th>OS</th>
                                <th>Nome do Projeto</th>
                                <th>Cliente</th>
                                <th>Local</th>
                                <th>Gestor</th>
                                <th>Data In√≠cio</th>
                                <th style="width: 120px;">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var projeto in projetosFiltrados)
                            {
                                <tr>
                                    <td><span class="badge bg-primary">@projeto.OsId</span></td>
                                    <td><strong>@projeto.NomeProjeto</strong></td>
                                    <td>@projeto.Cliente</td>
                                    <td>@projeto.Local</td>
                                    <td>@projeto.GestorProjeto</td>
                                    <td>@(projeto.DataInicio?.ToString("dd/MM/yyyy") ?? "-")</td>
                                    <td>
                                        <button class="btn btn-sm btn-warning me-1" title="Editar" @onclick="@(() => EditarProjeto(projeto))">
                                            ‚úèÔ∏è
                                        </button>
                                        <button class="btn btn-sm btn-danger" title="Excluir" @onclick="@(() => ExcluirProjeto(projeto))">
                                            üóëÔ∏è
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private List<Projeto> projetos = new();
    private List<Projeto> projetosFiltrados = new();
    private bool mostrarFormulario = false;
    private bool isLoading = true;
    private string filtro = string.Empty;
    private Projeto projetoEditando = new();

    protected override async Task OnInitializedAsync()
    {
        await CarregarProjetos();
    }

    private async Task CarregarProjetos()
    {
        try
        {
            isLoading = true;
            projetos = await DbContext.Projetos
                .OrderByDescending(p => p.DataCriacao)
                .ToListAsync();
            projetosFiltrados = projetos;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erro ao carregar projetos: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void MostrarFormularioNovo()
    {
        projetoEditando = new Projeto();
        mostrarFormulario = true;
    }

    private void EditarProjeto(Projeto projeto)
    {
        projetoEditando = new Projeto
        {
            Id = projeto.Id,
            OsId = projeto.OsId,
            NomeProjeto = projeto.NomeProjeto,
            Cliente = projeto.Cliente,
            Local = projeto.Local,
            GestorProjeto = projeto.GestorProjeto,
            DataInicio = projeto.DataInicio,
            Descricao = projeto.Descricao
        };
        mostrarFormulario = true;
    }

    private async Task SalvarProjeto()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(projetoEditando.OsId) || 
                string.IsNullOrWhiteSpace(projetoEditando.NomeProjeto) ||
                string.IsNullOrWhiteSpace(projetoEditando.Cliente) ||
                string.IsNullOrWhiteSpace(projetoEditando.Local))
            {
                // TODO: Implementar mensagem de erro
                Console.WriteLine("Campos obrigat√≥rios n√£o preenchidos");
                return;
            }

            if (projetoEditando.Id > 0)
            {
                // Editar
                var projetoDb = await DbContext.Projetos.FindAsync(projetoEditando.Id);
                if (projetoDb != null)
                {
                    projetoDb.OsId = projetoEditando.OsId;
                    projetoDb.NomeProjeto = projetoEditando.NomeProjeto;
                    projetoDb.Cliente = projetoEditando.Cliente;
                    projetoDb.Local = projetoEditando.Local;
                    projetoDb.GestorProjeto = projetoEditando.GestorProjeto;
                    projetoDb.DataInicio = projetoEditando.DataInicio;
                    projetoDb.Descricao = projetoEditando.Descricao;
                    projetoDb.DataAtualizacao = DateTime.Now;
                }
            }
            else
            {
                // Novo
                DbContext.Projetos.Add(projetoEditando);
            }

            await DbContext.SaveChangesAsync();
            await CarregarProjetos();
            CancelarEdicao();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erro ao salvar projeto: {ex.Message}");
        }
    }

    private async Task ExcluirProjeto(Projeto projeto)
    {
        if (confirm($"Deseja realmente excluir o projeto '{projeto.NomeProjeto}'?"))
        {
            try
            {
                DbContext.Projetos.Remove(projeto);
                await DbContext.SaveChangesAsync();
                await CarregarProjetos();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Erro ao excluir projeto: {ex.Message}");
            }
        }
    }

    private void CancelarEdicao()
    {
        projetoEditando = new Projeto();
        mostrarFormulario = false;
    }

    private void FiltrarProjetos()
    {
        if (string.IsNullOrWhiteSpace(filtro))
        {
            projetosFiltrados = projetos;
        }
        else
        {
            var filtroLower = filtro.ToLower();
            projetosFiltrados = projetos.Where(p => 
                p.OsId.ToLower().Contains(filtroLower) ||
                p.NomeProjeto.ToLower().Contains(filtroLower) ||
                p.Cliente.ToLower().Contains(filtroLower) ||
                p.Local.ToLower().Contains(filtroLower)
            ).ToList();
        }
    }

    private void LimparFiltro()
    {
        filtro = string.Empty;
        FiltrarProjetos();
    }

    // Fun√ß√£o JavaScript confirm (Blazor n√£o tem nativo)
    private bool confirm(string message)
    {
        // TODO: Implementar modal de confirma√ß√£o
        return true; // Por enquanto, sempre confirma
    }
}
